<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Simulation Tokamak - Plasma PIC (Stable)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #overlay {
            position: absolute; top: 10px; left: 10px; color: #00ffcc;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; 
            pointer-events: none; border: 1px solid #00ffcc;
            font-size: 14px;
        }
        h3 { margin: 0 0 10px 0; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/16/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
</head>
<body>

    <div id="overlay">
        <h3>Tokamak Monitor</h3>
        <div class="stat-line"><span>Particules:</span> <span id="pCount">0</span></div>
        <div class="stat-line"><span>Vitesse Max (v/c):</span> <span id="vMaxDisplay">0.00</span>%</div>
        <div class="stat-line" style="color:#aaa; font-size:0.9em; margin-top:5px;">
            <i>Moteur: Relativistic Boris Pusher<br>Interaction: Barnes-Hut Liénard-Wiechert</i>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONSTANTES & PARAMÈTRES
        // ==========================================
        
        const CONSTANTS = {
            c: 299792458,       // Vitesse lumière (m/s)
            e0: 8.854e-12,      // Permittivité
            mu0: 1.256e-6,      // Perméabilité
            me: 9.109e-31,      // Masse électron
            mp: 1.672e-27,      // Masse proton
            qe: 1.602e-19,      // Charge élémentaire
        };

        // Paramètres modifiables via l'interface
        const PARAMS = {
            numParticles: 1000,
            dt: 1e-11,           // Pas de temps (s)
            paused: false,
            
            // Physique Tokamak
            B0: 3.5,             // Champ Toroïdal (Tesla)
            Ip: 5e5,             // Courant Plasma (Amperes)
            R_maj: 20,           // Grand rayon (m) - Échelle exagérée pour visibilité
            r_min: 6,            // Petit rayon (m)
            
            // Scaling & Interactions
            WEIGHT: 1e6,         // 1 particule simu = N particules réelles
            interStrength: 0.0,  // Facteur d'interaction (commencer à 0 pour stabilité !)
            softening: 0.5,      // Évite la division par zéro quand r -> 0
            
            showTorus: true
        };

        // ==========================================
        // 2. CONFIGURATION THREE.JS
        // ==========================================
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(40, 30, 50);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const stats = new Stats();
        document.body.appendChild(stats.dom);

        // Repère visuel (Tore)
        const torusGeo = new THREE.TorusGeometry(PARAMS.R_maj, PARAMS.r_min, 16, 60);
        const torusMat = new THREE.MeshBasicMaterial({ color: 0x444444, wireframe: true, opacity: 0.2, transparent: true });
        const torusMesh = new THREE.Mesh(torusGeo, torusMat);
        torusMesh.rotation.x = Math.PI / 2;
        scene.add(torusMesh);
